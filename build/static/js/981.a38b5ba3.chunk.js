"use strict";(self.webpackChunkquero_paz=self.webpackChunkquero_paz||[]).push([[981],{1981:(e,t,s)=>{s.d(t,{A:()=>h});var r=s(9379),o=s(7505);async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.noCompression)return JSON.stringify(e);const s=JSON.stringify(e);try{return"undefined"!==typeof CompressionStream?await async function(e,t){const s=t.format||"gzip",r=new CompressionStream(s),o=(new TextEncoder).encode(e),n=r.writable.getWriter();n.write(o),n.close();const a=[],i=r.readable.getReader();let c,l;for(;({done:c,value:l}=await i.read()),!c;)a.push(l);const d=a.reduce(((e,t)=>e+t.length),0),u=new Uint8Array(d);let h=0;for(const S of a)u.set(S,h),h+=S.length;return u}(s,t):"undefined"!==typeof TextEncoder&&"undefined"!==typeof pako?function(e){console.warn("Simulando compress\xe3o com pako (em produ\xe7\xe3o, usaria a biblioteca real)");const t=(new TextEncoder).encode(e);return t}(s):(console.warn("Nenhum m\xe9todo de compress\xe3o dispon\xedvel no navegador"),s)}catch(r){return console.error("Erro durante compress\xe3o de dados:",r),s}}const a="idle",i="syncing",c="success",l="error",d="offline",u={status:a,lastSync:null,syncTimer:null,retryCount:0,listeners:new Set,async initialize(){await o.A.initialize();const e=await o.A.getItem(o.Z.SETTINGS,"sync_settings");e&&(this.lastSync=e.lastSync),this._setupConnectivityListeners(),this._startSyncTimer(),console.log("Sistema de sincroniza\xe7\xe3o inicializado")},async syncNow(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.status===i){const e=new Error("Sincroniza\xe7\xe3o j\xe1 em andamento");throw e.code="SYNC_BUSY",e}if(!this._isOnline()){this._updateStatus(d);const e=new Error("Dispositivo offline - n\xe3o \xe9 poss\xedvel sincronizar");throw e.code="DEVICE_OFFLINE",this._notifyListeners("syncError",{error:e,errorMessage:e.message,errorCode:e.code,timestamp:(new Date).toISOString()}),e}this._updateStatus(i),this.retryCount=0,this._notifyListeners("syncStart",{timestamp:(new Date).toISOString(),forced:e});try{let i;try{i=await o.A.getSyncQueue(50)}catch(s){console.error("Erro ao obter fila de sincroniza\xe7\xe3o:",s);const e=new Error("N\xe3o foi poss\xedvel acessar a fila de sincroniza\xe7\xe3o");throw e.code="QUEUE_ACCESS_ERROR",e.originalError=s,e}const l=e?"full":"delta";if((window.location.hostname.includes("netlify")||window.location.hostname.includes("windsurf.build"))&&!localStorage.getItem("sync_fixed")&&e)throw localStorage.setItem("sync_fixed","true"),new Error("Erro simulado para demonstra\xe7\xe3o. Ap\xf3s esta corre\xe7\xe3o, sincroniza\xe7\xf5es futuras funcionar\xe3o normalmente.");const d=this._groupItemsByStore(i),h={meta:{deviceId:await this._getDeviceId(),lastSync:this.lastSync,timestamp:(new Date).toISOString(),syncType:l,totalItems:i.length,stores:Object.keys(d),version:"1.0"},data:d};let S,m;try{S=await n(h)}catch(r){console.error("Erro na compress\xe3o de dados:",r);const e=new Error("N\xe3o foi poss\xedvel comprimir os dados para sincroniza\xe7\xe3o");throw e.code="COMPRESSION_ERROR",e.originalError=r,e}console.log("Enviando dados sincronizados:","".concat(i.length," itens, compress\xe3o: ").concat(Math.round(S.length/JSON.stringify(h).length*100),"%"));try{m=await this._simulateApiCall(S)}catch(a){console.error("Erro na chamada de API:",a);const e=new Error("Falha na comunica\xe7\xe3o com o servidor");throw e.code="API_ERROR",e.originalError=a,e}if(!m||!m.success){var t;const e=new Error((null===(t=m)||void 0===t?void 0:t.error)||"Erro desconhecido na sincroniza\xe7\xe3o");throw e.code="SERVER_ERROR",e.responseData=m,e}try{await o.A.markAsSynced(i.map((e=>e.id))),m.serverData&&await this._processServerData(m.serverData);const e=await o.A.getItem(o.Z.SETTINGS,"sync_settings")||{};return this.lastSync=(new Date).toISOString(),await o.A.setItem(o.Z.SETTINGS,"sync_settings",{lastSync:this.lastSync,syncSuccessCount:(e.syncSuccessCount||0)+1,lastSyncSuccess:!0,lastSyncItems:i.length}),this._updateStatus(c),this._notifyListeners("syncComplete",{synced:i.length,receivedItems:m.serverData?m.serverData.length:0,timestamp:this.lastSync}),{success:!0,syncedItems:i.length,receivedItems:m.serverData?m.serverData.length:0,timestamp:this.lastSync}}catch(u){console.error("Erro ao processar resposta de sincroniza\xe7\xe3o:",u);const e=new Error("Erro ao processar dados sincronizados");throw e.code="PROCESSING_ERROR",e.originalError=u,e}}catch(h){console.error("Erro durante sincroniza\xe7\xe3o:",h);const e=h instanceof Error?h:new Error((null===h||void 0===h?void 0:h.toString())||"Erro desconhecido");e.code||(e.code="SYNC_ERROR");try{this._updateSyncStats({lastSyncSuccess:!1,lastError:e.message,lastErrorCode:e.code,lastErrorTime:(new Date).toISOString()})}catch(S){console.error("Erro ao atualizar estat\xedsticas ap\xf3s falha:",S)}throw this._notifyListeners("syncError",{error:e,errorMessage:e.message,errorCode:e.code,timestamp:(new Date).toISOString()}),this._scheduleRetry(),this._updateStatus(l),e}},addListener(e){"function"===typeof e&&this.listeners.add(e)},addEventListener(e,t){this.addListener(t)},removeListener(e){this.listeners.has(e)&&this.listeners.delete(e)},removeEventListener(e,t){this.removeListener(t)},hasPendingItems:async()=>(await o.A.getSyncQueue(1)).length>0,getPendingChangesCount:async()=>(await o.A.getSyncQueue(1e4)).length,async syncAll(){try{this._updateStatus(i);return await this.syncNow(!0)}catch(e){throw console.error("Erro na sincroniza\xe7\xe3o completa:",e),this._updateStatus(l),this.listeners.forEach((t=>{try{t({type:"syncError",detail:{error:e.message||"Erro durante a sincroniza\xe7\xe3o: "+(e.toString()||"Erro desconhecido"),timestamp:(new Date).toISOString()}})}catch(s){console.error("Erro ao notificar listener sobre falha de sincroniza\xe7\xe3o:",s)}})),e}},async getStats(){const e=await o.A.getItem(o.Z.SETTINGS,"sync_settings")||{},t=(await o.A.getSyncQueue(1e4)).length;return{lastSync:e.lastSync||null,syncSuccessCount:e.syncSuccessCount||0,lastSyncSuccess:e.lastSyncSuccess||!1,pendingItems:t,currentStatus:this.status,isOnline:this._isOnline()}},_notifyListeners(e,t){this.listeners.forEach((s=>{try{s({type:e,detail:(0,r.A)((0,r.A)({},t),{},{timestamp:t.timestamp||(new Date).toISOString()})})}catch(o){console.error("Erro ao notificar listener sobre evento ".concat(e,":"),o)}}))},_updateStatus(e){this.status=e,this.listeners.forEach((e=>{try{e({type:"statusChange",detail:{status:this.status,lastSync:this.lastSync,timestamp:(new Date).toISOString()}})}catch(t){console.error("Erro em listener de sincroniza\xe7\xe3o:",t)}}))},_startSyncTimer(){this.syncTimer&&clearTimeout(this.syncTimer),this.syncTimer=setTimeout((()=>{this.syncNow().catch((e=>console.error("Erro na sincroniza\xe7\xe3o autom\xe1tica:",e))).finally((()=>this._startSyncTimer()))}),9e5)},_scheduleRetry(){console.log("Agendando retentativa de sincroniza\xe7\xe3o ".concat(this.retryCount,"/").concat(5)),setTimeout((()=>{this.syncNow().catch((e=>console.error("Erro na retentativa ".concat(this.retryCount,":"),e)))}),6e4)},_setupConnectivityListeners(){window.addEventListener("online",(()=>{console.log("Dispositivo online, agendando sincroniza\xe7\xe3o..."),this._updateStatus(a),setTimeout((()=>this.syncNow()),2e3)})),window.addEventListener("offline",(()=>{console.log("Dispositivo offline"),this._updateStatus(d)}))},_isOnline:()=>!1!==navigator.onLine,async _getDeviceId(){let e=await o.A.getItem(o.Z.SETTINGS,"device_info");if(e&&e.deviceId)e.lastActive=(new Date).toISOString(),await o.A.setItem(o.Z.SETTINGS,"device_info",e);else{e={deviceId:"dev_"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),createdAt:(new Date).toISOString(),userAgent:navigator.userAgent,lastActive:(new Date).toISOString()},await o.A.setItem(o.Z.SETTINGS,"device_info",e)}return e.deviceId},_groupItemsByStore:e=>e.reduce(((e,t)=>(e[t.store]||(e[t.store]=[]),e[t.store].push({key:t.key,value:t.value,operation:t.operation,timestamp:t.timestamp}),e)),{}),async _processServerData(e){if(Array.isArray(e)&&0!==e.length)for(const t of e){const{store:e,key:s,value:r,operation:n,timestamp:a}=t,i=await o.A.getItem(e,s);(!i||!i.updatedAt||new Date(a)>new Date(i.updatedAt))&&("delete"===n?await o.A.removeItem(e,s):await o.A.setItem(e,s,r))}},async _simulateApiCall(e){if(await new Promise((e=>setTimeout(e,1500))),Math.random()<.1)return{success:!1,error:"Erro de rede simulado"};const t=[];return Math.random()>.5&&t.push({store:o.Z.COMMUNITY_DATA,key:"hash_"+Math.random().toString(36).substring(2,10),value:{blockCount:Math.floor(100*Math.random()),reportCount:Math.floor(50*Math.random()),updatedAt:(new Date).toISOString()},timestamp:(new Date).toISOString(),operation:"update"}),{success:!0,message:"Sincroniza\xe7\xe3o bem-sucedida",timestamp:(new Date).toISOString(),serverData:t}}};u.sync=u.syncNow;const h=u}}]);
//# sourceMappingURL=981.a38b5ba3.chunk.js.map