"use strict";(self.webpackChunkquero_paz=self.webpackChunkquero_paz||[]).push([[505],{7505:(e,t,o)=>{o.d(t,{A:()=>l,Z:()=>s});var a=o(9379);const r="quero_paz_db",s={SETTINGS:"settings",CALLS:"calls",REPUTATION:"reputation",COMMUNITY_DATA:"community_data",SYNC_QUEUE:"sync_queue",PROFILES:"profiles",RULES:"rules",TEST:"test",STATISTICS:"statistics",SYNC:"sync"},c=()=>new Promise(((e,t)=>{console.log("Tentando excluir o banco de dados antigo...");const o=indexedDB.deleteDatabase(r);o.onsuccess=()=>{console.log("Banco de dados exclu\xeddo com sucesso"),e(!0)},o.onerror=t=>{console.warn("Erro ao excluir banco de dados:",t),e(!1)},o.onblocked=()=>{console.warn("Exclus\xe3o do banco de dados bloqueada. Feche todas as outras abas."),e(!1)}})),n=new Map,i={_initialized:!1,_isDBReady:!1,async initialize(){this._initialized=!1,this._isDBReady=!1;try{console.log("Iniciando inicializa\xe7\xe3o do OfflineStorage...");localStorage.getItem("force_db_reset")||(console.log("Iniciando exclus\xe3o do banco de dados para nova vers\xe3o..."),await c(),localStorage.setItem("force_db_reset","true")),this.db=await this._openDatabase(),console.log("IndexedDB inicializado com sucesso com vers\xe3o",6);return this._verifyAllStoresExist()||(console.warn("Alguns stores n\xe3o foram encontrados. Recriando banco de dados..."),await this._recreateDatabase(),this.db=await this._openDatabase()),await this._loadCriticalDataToCache(),this._isDBReady=!0,this._initialized=!0,console.log("OfflineStorage inicializado com sucesso. Banco pronto:",this._isDBReady),console.log("Stores dispon\xedveis:",Array.from(this.db.objectStoreNames).join(", ")),localStorage.setItem("db_initialized","true"),this.db}catch(e){console.error("Erro ao inicializar OfflineStorage:",e),this._initialized=!1,this._isDBReady=!1,this._setupFallbackStorage(),localStorage.setItem("db_initialized","false"),console.log("Configurado armazenamento de fallback devido a falha no IndexedDB")}},_verifyAllStoresExist(){try{if(!this.db)return!1;const e=[s.SETTINGS,s.CALLS,s.REPUTATION,s.COMMUNITY_DATA,s.SYNC_QUEUE,s.PROFILES,s.RULES,s.TEST,s.STATISTICS,s.SYNC].filter((e=>!this.db.objectStoreNames.contains(e)));return!(e.length>0)||(console.warn("Stores faltando:",e.join(", ")),!1)}catch(e){return console.error("Erro ao verificar stores:",e),!1}},async _recreateDatabase(){try{return console.log("Recriando banco de dados por completo..."),this.db&&(this.db.close(),this.db=null),await c(),localStorage.removeItem("force_db_reset"),console.log("Banco de dados foi exclu\xeddo e ser\xe1 recriado na pr\xf3xima inicializa\xe7\xe3o"),!0}catch(e){return console.error("Erro ao recriar banco de dados:",e),!1}},async getItem(e,t){const o="".concat(e,":").concat(t);if(n.has(o))return n.get(o);try{if(this.db){const a=this.db.transaction(e,"readonly").objectStore(e),r=await this._promisifyRequest(a.get(t));return void 0!==r&&n.set(o,r),r}return this.fallbackStorage?this.fallbackStorage.getItem(o):null}catch(a){return console.error("Erro ao obter item ".concat(t," do store ").concat(e,":"),a),this.fallbackStorage?this.fallbackStorage.getItem(o):null}},async setItem(e,t,o){try{if(n.set("".concat(e,":").concat(t),o),!this.db)return void localStorage.setItem("".concat(e,":").concat(t),JSON.stringify(o));const r=this.db.transaction(e,"readwrite"),s=r.objectStore(e),c=null!==s.keyPath;await new Promise(((e,n)=>{let i;if(c){const e=s.keyPath,r="object"===typeof o&&null!==o?(0,a.A)((0,a.A)({},o),{},{[e]:t}):{[e]:t,data:o};i=s.put(r)}else i=s.put(o,t);r.oncomplete=()=>e(),r.onerror=e=>n(e.target.error)})),this._isSyncableStore(e)&&await this._addToSyncQueue(e,t,o)}catch(r){console.error("Erro ao armazenar item ".concat(t," no store ").concat(e,":"),r);try{localStorage.setItem("".concat(e,":").concat(t),JSON.stringify(o))}catch(s){throw console.error("Falha no fallback para localStorage:",s),r}}},async removeItem(e,t){const o="".concat(e,":").concat(t);n.delete(o);try{if(this.db){const o=this.db.transaction(e,"readwrite").objectStore(e);return await this._promisifyRequest(o.delete(t)),void(this._isSyncableStore(e)&&await this._addToSyncQueue(e,t,null,"delete"))}if(this.fallbackStorage)return void this.fallbackStorage.removeItem(o)}catch(a){console.error("Erro ao remover item ".concat(t," do store ").concat(e,":"),a),this.fallbackStorage&&this.fallbackStorage.removeItem(o)}},async getAllItems(e){try{if(this.db){const t=this.db.transaction(e,"readonly").objectStore(e);return await this._promisifyRequest(t.getAll())||[]}return this.fallbackStorage?this.fallbackStorage.getAllItems(e):[]}catch(t){return console.error("Erro ao obter todos os itens do store ".concat(e,":"),t),this.fallbackStorage?this.fallbackStorage.getAllItems(e):[]}},clearCache(e){if(e){const t="".concat(e,":");for(const e of n.keys())e.startsWith(t)&&n.delete(e)}else n.clear()},async clearStore(e){this.clearCache(e);try{if(this.db){const t=this.db.transaction(e,"readwrite").objectStore(e);return await this._promisifyRequest(t.clear()),void(this._isSyncableStore(e)&&await this._addToSyncQueue(e,null,null,"clear"))}if(this.fallbackStorage)return void this.fallbackStorage.clearStore(e)}catch(t){console.error("Erro ao limpar store ".concat(e,":"),t),this.fallbackStorage&&this.fallbackStorage.clearStore(e)}},async _addToSyncQueue(e,t,o){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"update";try{const r={id:"".concat(e,":").concat(t,":").concat(Date.now()),store:e,key:t,value:o,operation:a,timestamp:(new Date).toISOString(),attempts:0,synced:!1},c=this.db.transaction(s.SYNC_QUEUE,"readwrite").objectStore(s.SYNC_QUEUE);await this._promisifyRequest(c.add(r))}catch(r){console.error("Erro ao adicionar \xe0 fila de sincroniza\xe7\xe3o:",r)}},async getSyncQueue(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;try{if(!this.db)return[];const t=this.db.transaction(s.SYNC_QUEUE,"readonly").objectStore(s.SYNC_QUEUE),o=t.index("synced").getAll(0,e);return await this._promisifyRequest(o)}catch(t){return console.error("Erro ao obter fila de sincroniza\xe7\xe3o:",t),[]}},async markAsSynced(e){if(Array.isArray(e)&&0!==e.length)try{const t=this.db.transaction(s.SYNC_QUEUE,"readwrite").objectStore(s.SYNC_QUEUE),o=e.map((async e=>{const o=await this._promisifyRequest(t.get(e));if(o)return o.synced=!0,o.syncedAt=(new Date).toISOString(),this._promisifyRequest(t.put(o))}));await Promise.all(o)}catch(t){console.error("Erro ao marcar itens como sincronizados:",t)}},_isSyncableStore:e=>[s.CALLS,s.REPUTATION,s.PROFILES,s.RULES].includes(e),async _loadCriticalDataToCache(){try{const e=await this.getItem(s.SETTINGS,"app_settings");e&&n.set("".concat(s.SETTINGS,":app_settings"),e);const t=await this._getActiveProfiles();if(t&&t.length>0)for(const a of t)n.set("".concat(s.PROFILES,":").concat(a.id),a);const o=await this._getActiveRules();if(o&&o.length>0)for(const a of o)n.set("".concat(s.RULES,":").concat(a.id),a)}catch(e){console.error("Erro ao carregar dados cr\xedticos para o cache:",e)}},async _getActiveProfiles(){try{if(!this.db)return[];const e=this.db.transaction(s.PROFILES,"readonly").objectStore(s.PROFILES),t=e.index("status").getAll("active");return await this._promisifyRequest(t)}catch(e){return console.error("Erro ao obter perfis ativos:",e),[]}},async _getActiveRules(){try{if(!this.db)return[];const e=this.db.transaction(s.RULES,"readonly").objectStore(s.RULES),t=e.index("status").getAll("active");return await this._promisifyRequest(t)}catch(e){return console.error("Erro ao obter regras ativas:",e),[]}},_openDatabase:async()=>new Promise(((e,t)=>{if(!window.indexedDB)return void t(new Error("IndexedDB n\xe3o suportado neste navegador"));const o=indexedDB.open(r,6);o.onerror=e=>{console.error("Erro ao abrir IndexedDB:",e.target.error),t(new Error("Erro ao abrir IndexedDB: "+e.target.error))},o.onsuccess=t=>{const o=t.target.result;console.log("IndexedDB aberto com sucesso. Vers\xe3o:",o.version),console.log("Stores dispon\xedveis:",Array.from(o.objectStoreNames).join(", ")),e(o)},o.onupgradeneeded=e=>{console.log("Atualizando estrutura do banco de dados para vers\xe3o",6);const t=e.target.result,o=function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];try{if(t.objectStoreNames.contains(e))return console.log("Store ".concat(e," j\xe1 existe. Pulando cria\xe7\xe3o.")),t.transaction(e).objectStore(e);console.log("Criando store ".concat(e,"..."));const r=o?t.createObjectStore(e,{keyPath:o}):t.createObjectStore(e);return a.forEach((e=>{let{name:t,path:o,options:a}=e;r.createIndex(t,o,a||{unique:!1})})),r}catch(r){throw console.error("Erro ao criar store ".concat(e,":"),r),r}};o(s.SETTINGS),o(s.CALLS,"id",[{name:"timestamp",path:"timestamp"},{name:"phoneNumber",path:"phoneNumber"},{name:"status",path:"status"}]),o(s.REPUTATION,"phoneNumber",[{name:"category",path:"category"},{name:"score",path:"score"}]),o(s.COMMUNITY_DATA,"phoneHash",[{name:"updatedAt",path:"updatedAt"},{name:"expiresAt",path:"expiresAt"}]),o(s.SYNC_QUEUE,"id",[{name:"synced",path:"synced"},{name:"timestamp",path:"timestamp"},{name:"store",path:"store"}]),o(s.PROFILES,"id",[{name:"status",path:"status"},{name:"type",path:"type"}]),o(s.RULES,"id",[{name:"status",path:"status"},{name:"type",path:"type"}]),o(s.TEST,"id"),o(s.STATISTICS,"id"),o(s.SYNC,"id"),console.log("Atualiza\xe7\xe3o da estrutura do banco de dados conclu\xedda.")}})),_promisifyRequest:e=>new Promise(((t,o)=>{e.onsuccess=e=>t(e.target.result),e.onerror=e=>o(e.target.error)})),_setupFallbackStorage(){console.warn("Usando fallback para localStorage"),this.fallbackStorage={getItem(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.error("Erro ao ler do localStorage:",t),null}},setItem(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(o){console.error("Erro ao escrever no localStorage:",o)}},removeItem(e){try{localStorage.removeItem(e)}catch(t){console.error("Erro ao remover do localStorage:",t)}},getAllItems(e){try{const t=[],o="".concat(e,":");for(let e=0;e<localStorage.length;e++){const a=localStorage.key(e);a.startsWith(o)&&t.push(this.getItem(a))}return t}catch(t){return console.error("Erro ao ler todos os itens do localStorage:",t),[]}},clearStore(e){try{const t="".concat(e,":"),o=[];for(let e=0;e<localStorage.length;e++){const a=localStorage.key(e);a.startsWith(t)&&o.push(a)}o.forEach((e=>localStorage.removeItem(e)))}catch(t){console.error("Erro ao limpar store no localStorage:",t)}}}}},l=i;i.getItemDirect=async function(e){try{let t=s.SETTINGS,o=e;if(e.includes(":")){const a=e.split(":");t=a[0],o=a.slice(1).join(":")}return await this.getItem(t,o)}catch(t){return console.error("Erro ao obter item ".concat(e," diretamente:"),t),null}},i._originalGetItem=i.getItem,i.getItem=function(e,t){return void 0===t?this.getItemDirect(e):this._originalGetItem(e,t)},i.setItemDirect=async function(e,t){try{let o=s.SETTINGS,a=e;if(e.includes(":")){const t=e.split(":");o=t[0],a=t.slice(1).join(":")}return await this.setItem(o,a,t),!0}catch(o){return console.error("Erro ao armazenar item ".concat(e," diretamente:"),o),!!this.fallbackStorage&&(this.fallbackStorage.setItem(e,t),!0)}},i._originalSetItem=i.setItem,i.setItem=function(e,t,o){return void 0===o?this.setItemDirect(e,t):this._originalSetItem(e,t,o)},i.removeItemDirect=async function(e){try{let t=s.SETTINGS,o=e;if(e.includes(":")){const a=e.split(":");t=a[0],o=a.slice(1).join(":")}const a=this.db.transaction(t,"readwrite").objectStore(t);await this._promisifyRequest(a.delete(o));const r="".concat(t,":").concat(o);return n.delete(r),!0}catch(t){return console.error("Erro ao remover item ".concat(e," diretamente:"),t),!!this.fallbackStorage&&(this.fallbackStorage.removeItem(e),!0)}},i._originalRemoveItem=i.removeItem,i.removeItem=function(e,t){return void 0===t?this.removeItemDirect(e):this._originalRemoveItem(e,t)}}}]);
//# sourceMappingURL=505.11d89529.chunk.js.map